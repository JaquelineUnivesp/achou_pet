{% extends 'core/base.html' %}
{% load static %}
{% block title %}Cadastrar Pet Perdido - Achou Pet{% endblock %}
{% block content %}

<div class="container mt-5">
   <div class="row">
      <div class="col-3">
         {% include "core/sidebar_user.html" %}
      </div>
      <div class="col-9">
         <h1 class="display-1 text-center">Cadastro de pet <span class="color_project">perdido</span></h1>
         <p class="text-center">Se você está procurando um pet perdido ou quer cadastrar um pet que você encontrou, você está no lugar certo.</p>

         {% if form.errors %}
         <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Erro ao cadastrar:</strong>
            <ul>
               {% for field in form %}
               {% for error in field.errors %}
               <li>{{ field.label }}: {{ error }}</li>
               {% endfor %}
               {% endfor %}
               {% for error in form.non_field_errors %}
               <li>{{ error }}</li>
               {% endfor %}
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
         </div>
         {% endif %}

         <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            {{ form.as_p }}

            <div id="map" style="height: 300px; width: 100%; margin-top: 10px; background-color: #e0e0e0;"></div>
            <small class="text-muted">Clique no mapa para ajustar a localização. O endereço será preenchido automaticamente.</small>

            <button type="submit" class="btn rounded-pill background_project mt-3">Cadastrar</button>
         </form>
      </div>
   </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
document.addEventListener('DOMContentLoaded', function () {
    const map = L.map('map').setView([-23.5489, -46.6388], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    let marker = null;
    const latitudeInput = document.getElementById('id_latitude');
    const longitudeInput = document.getElementById('id_longitude');
    const locationInput = document.getElementById('id_lost_location');

    if (latitudeInput.value && longitudeInput.value) {
        marker = L.marker([latitudeInput.value, longitudeInput.value]).addTo(map);
        map.setView([latitudeInput.value, longitudeInput.value], 15);
    }

    map.on('click', function (e) {
        const lat = e.latlng.lat.toFixed(6);
        const lon = e.latlng.lng.toFixed(6);
        latitudeInput.value = lat;
        longitudeInput.value = lon;
        if (marker) { map.removeLayer(marker); }
        marker = L.marker([lat, lon]).addTo(map);

        fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
            .then(response => response.json())
            .then(data => {
                const address = data.address;
                let locationString = '';
               if (address.road) locationString += address.road + ', ';
                if (address.suburb) locationString += address.suburb + ', ';
                if (address.city) locationString += address.city + ', ';
                if (address.state) locationString += address.state + ', ';
                if (address.country) locationString += address.country;
                locationInput.value = locationString;
            });
    });

const breedsCats = [
    "Sem Raça", "Abissínio", "American Bobtail", "American Curl", "American Shorthair",
    "Balinese", "Bengal", "Birmanês", "Bombaim", "British Shorthair",
    "Burmês", "Chartreux", "Cornish Rex", "Devon Rex", "Egyptian Mau",
    "Exótico", "Himalaio", "Japanese Bobtail", "Korat", "LaPerm",
    "Maine Coon", "Manx", "Florestal Norueguês", "Ocicat", "Oriental",
    "Persa", "Ragdoll", "Azul Russo", "Scottish Fold", "Selkirk Rex",
    "Siamês", "Siberiano", "Singapura", "Snowshoe", "Somali", "Sphynx",
    "Tonquinês", "Angorá Turco", "Van Turco", "Outra Raça"
  ];

  const breedsDogs = [
    "Sem Raça", "Pastor Alemão", "Pastor Belga", "Pastor de Shetland",
    "Affenpinscher", "Afghan Hound", "Airedale Terrier", "Akita",
    "Alaskan Malamute", "American Bulldog", "American Pit Bull Terrier",
    "Australian Cattle Dog", "Australian Shepherd", "Basset Hound",
    "Beagle", "Belgian Malinois", "Bernese Mountain Dog", "Bichon Frisé",
    "Bloodhound", "Border Collie", "Boston Terrier", "Boxer",
    "Bull Terrier", "Bulldog Francês", "Bulldog Inglês", "Cairn Terrier",
    "Cane Corso", "Cavalier King Charles Spaniel", "Chihuahua",
    "Chow Chow", "Cocker Spaniel", "Collie", "Dachshund", "Dálmata",
    "Doberman", "Dogo Argentino", "Golden Retriever", "Dog Alemão",
    "Greyhound", "Havanês", "Jack Russell Terrier", "Labrador Retriever",
    "Lhasa Apso", "Maltês", "Mastiff", "Pinscher Miniatura",
    "Terra Nova", "Papillon", "Pequinês", "Corgi", "Poodle",
    "Spitz Alemão", "Pug", "Rottweiler", "São Bernardo",
    "Samoyeda", "Schnauzer", "Scottish Terrier", "Shar Pei", "Shiba Inu",
    "Shih Tzu", "Husky Siberiano", "Staffordshire Bull Terrier",
    "Weimaraner", "West Highland Terrier", "Whippet", "Yorkshire Terrier",
    "Outra Raça"
  ];

    const speciesSelect = document.getElementById('id_species');
    const breedSelect = document.getElementById('id_breed');

    function updateBreeds() {
        const species = speciesSelect.value.toLowerCase();
        const breeds = species === 'gato' ? breedsCats : breedsDogs;

        breedSelect.innerHTML = '';
        breeds.forEach(breed => {
            const option = new Option(breed, breed);
            breedSelect.add(option);
        });
    }

    updateBreeds();
    speciesSelect.addEventListener('change', updateBreeds);
});
</script>

{% endblock %}
