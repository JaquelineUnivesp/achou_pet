{% extends 'core/base.html' %}
{% load static %}
{% block title %}Cadastrar Pet Perdido - Achou Pet{% endblock %}
{% block content %}

<div class="container mt-5">
   <div class="row">
      <div class="col-3">
         {% include "core/sidebar_user.html" %}
      </div>
      <div class="col-9">
         <h1 class="display-1 text-center">Cadastro de pet <span class="color_project">perdido</span></h1>
         <p class="text-center">Se você está procurando um pet perdido ou quer cadastrar um pet que você encontrou, você está no lugar certo.</p>

         {% if form.errors %}
         <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Erro ao cadastrar:</strong>
            <ul>
               {% for field in form %}
               {% for error in field.errors %}
               <li>{{ field.label }}: {{ error }}</li>
               {% endfor %}
               {% endfor %}
               {% for error in form.non_field_errors %}
               <li>{{ error }}</li>
               {% endfor %}
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
         </div>
         {% endif %}

         <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="mb-3">
               <label for="id_name" class="form-label">Nome do Pet</label>
               {{ form.name }}
            </div>

            <div class="mb-3">
               <label for="id_species">Espécie</label>
               {{ form.species }}
            </div>
            <div class="mb-3">
               <label for="id_size">Tamanho</label>
               {{ form.size }}
            </div>
            <div class="mb-3">
               <label for="id_breed">Raça</label>
               {{ form.breed }}
            </div>
            <div class="mb-3">
               <label for="id_color">Cor</label>
               {{ form.color }}
            </div>
            <div class="mb-3">
               <label for="id_coat_type">Tipo de Pelagem</label>
               {{ form.coat_type }}
            </div>
            <div class="mb-3">
               <label for="id_eye_color">Cor dos Olhos</label>
               {{ form.eye_color }}
            </div>

            <div class="row mb-3">
               <div class="col-md-6">
                  <label for="id_age_value" class="form-label">Idade</label>
                  <div class="input-group">
                     {{ form.age_value }}
                     {{ form.age_unit }}
                  </div>
               </div>
               <div class="col-md-6">
                  <label for="id_weight" class="form-label">Peso</label>
                  {{ form.weight }}
               </div>
            </div>

            <div class="mb-3">
               <label for="id_sex">Sexo</label>
               {{ form.sex }}
            </div>
            <div class="mb-3">
               <label for="id_lost_date">Data</label>
               {{ form.lost_date }}
            </div>
            <div class="mb-3">
               <label for="id_location">Localização</label>
               {{ form.location }}
            </div>
            <div class="mb-3">
               <label for="id_photo_1">Foto do Pet</label>
               {{ form.photo_1 }}
            </div>
            <div class="mb-3">
               <label for="id_photo_2">Foto Secundária</label>
               {{ form.photo_2 }}
            </div>
            <div class="mb-3">
               <label for="id_photo_3">Foto Adicional</label>
               {{ form.photo_3 }}
            </div>
            <div class="mb-3">
               <label for="id_status">Status</label>
               {{ form.status }}
            </div>
            <div class="mb-3">
               <label for="id_notification_phone">Telefone de Notificação</label>
               {{ form.notification_phone }}
            </div>
            <div class="mb-3">
               <label for="id_lost_location">Local de Perda</label>
               {{ form.lost_location }}
            </div>
            <div id="map" style="height: 400px; margin-bottom: 20px;"></div>

            <div class="form-check mb-3">
               {{ form.terms_accepted }}
               <label class="form-check-label" for="id_terms_accepted">Eu aceito os Termos de Uso</label>
            </div>
            <div class="form-check mb-3">
               {{ form.privacy_accepted }}
               <label class="form-check-label" for="id_privacy_accepted">Eu aceito a Política de Privacidade</label>
            </div>

            {{ form.latitude }}
            {{ form.longitude }}

            <button type="submit" class="btn rounded-pill background_project">Cadastrar</button>
         </form>
      </div>
   </div>
</div>

<!-- Dependências e Estilos (mantidos) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<!-- Script do mapa (mantido igual ao anterior) -->
<script>
   var map = L.map('map').setView([-23.5489, -46.6388], 13);
   L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
   var marker;

   if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
         const { latitude, longitude } = position.coords;
         map.setView([latitude, longitude], 13);
         addMarker(latitude, longitude);
      }, function() {
         obterLocalizacaoUsuario();
      });
   } else {
      obterLocalizacaoUsuario();
   }

   function addMarker(lat, lon) {
      if (marker) marker.remove();
      marker = L.marker([lat, lon], { draggable: true }).addTo(map);
      marker.on('dragend', function(e) {
         const { lat, lng } = e.target.getLatLng();
         reverseGeocode(lat, lng);
      });
      reverseGeocode(lat, lon);
   }

   function reverseGeocode(lat, lon) {
      fetch(`https://api.locationiq.com/v1/reverse?key=pk.227bb16be8af10a97550047d4932e148&lat=${lat}&lon=${lon}&format=json`)
         .then(response => response.json())
         .then(data => {
            document.getElementById('id_lost_location').value = data.display_name;
            document.getElementById('id_latitude').value = lat.toFixed(6);
            document.getElementById('id_longitude').value = lon.toFixed(6);
         });
   }

   map.on('click', function(e) {
      const { lat, lng } = e.latlng;
      addMarker(lat, lng);
   });

   L.Control.geocoder({ defaultMarkGeocode: false })
      .on('markgeocode', function(e) {
         const latlng = e.geocode.center;
         addMarker(latlng.lat, latlng.lng);
         map.setView(latlng, 16);
      })
      .addTo(map);

   function obterLocalizacaoUsuario() {
      fetch('https://ipinfo.io/json?token=91e3040b4f78f5')
         .then(response => response.json())
         .then(data => {
            const [latitude, longitude] = data.loc.split(',');
            map.setView([latitude, longitude], 12);
            addMarker(latitude, longitude);
         });
   }
</script>

{% endblock %}
