{% extends 'core/base.html' %}
{% load static %}
{% block title %}Buscar Pets Perdidos - Achou Pet{% endblock %}

{% block content %}
<div class="container mt-5">
  <!-- Cabeçalho e Botão -->
  <div class="row">
    <div class="col-md-9">
      <h1 class="display-1 text-left">
        Buscar Pets <span class="color_project">Perdidos</span>
      </h1>
      <p class="text-left">Encontre pets perdidos ou encontrados na sua região.</p>
    </div>
    <div class="col-md-3">
      <button class="pill-button">
        <a href="{% url 'pet_registration:register_lost_pet' %}">Cadastrar Pet Perdido</a>
      </button>
    </div>
  </div>

  <!-- Mapa -->
  <div id="map" style="height: 400px; width: 100%; margin-bottom: 20px; background-color: #e0e0e0;"></div>

  <div class="search-container row">
    <aside class="sidebar col-md-3">
      <form method="get" action="" id="filter-form" class="p-3 border rounded">
        {% csrf_token %}
        <!-- Filtros omitidos para brevidade (mantêm o seu código original) -->
        <!-- ... seus campos de filtro continuam aqui ... -->
        <button type="submit" class="btn btn-primary mt-2 w-100">Filtrar</button>
        <a href="/search/lost/" class="btn btn-secondary mt-2 w-100">Limpar Filtros</a>
      </form>
    </aside>

    <section class="results col-md-9">
      <h3>Resultados ({{ lost_pets|length }})</h3>
      <div class="row" id="pets-list">
        {% for pet in lost_pets %}
          <div class="col-md-4 mb-4 pet-item"
               data-id="{{ pet.id }}"
               data-lat="{{ pet.latitude|floatformat:"6"|default:"" }}"
               data-lng="{{ pet.longitude|floatformat:"6"|default:"" }}"
               data-status="{{ pet.status }}">
            <div class="card h-100">
              {% if pet.photo_1 %}
                <img src="{{ pet.photo_1.url }}" class="card-img-top" alt="{{ pet.name|default:'Pet sem nome' }}" style="height: 200px; object-fit: cover;">
              {% else %}
                <div class="card-img-top text-center bg-light" style="height: 200px; line-height: 200px; color: #aaa;">Sem imagem</div>
              {% endif %}
              <div class="card-body">
                <h5 class="card-title">{{ pet.name|default:"Pet sem nome" }}</h5>
                <ul class="list-unstyled">
                  <li><strong>Status:</strong> {{ pet.status|capfirst }}</li>
                  <li><strong>Espécie:</strong> {{ pet.species|capfirst }}</li>
                  <li><strong>Tamanho:</strong> {{ pet.size|capfirst }}</li>
                  <li><strong>Raça:</strong> {{ pet.breed|default:"Não especificado" }}</li>
                  <li><strong>Cor:</strong> {{ pet.color }}</li>
                  <li><strong>Sexo:</strong> {{ pet.sex|capfirst }}</li>
                  <li><strong>Data de Perda:</strong> {{ pet.lost_date|date:"d \d\e F \d\e Y" }}</li>
                  <li><strong>Local:</strong> {{ pet.lost_location }}</li>
                </ul>
                <a href="{% url 'pet_registration:lost_pet_detail' pet_id=pet.id %}" class="btn btn-primary">Ver Detalhes</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>
  </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Script do Mapa -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const map = L.map('map').setView([-23.5489, -46.6388], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  const iconLost = L.icon({
    iconUrl: '{% static "images/small-red-cutout.png" %}',
    iconSize: [31, 43],
    iconAnchor: [15, 30],
    popupAnchor: [0, -30]
  });

  const iconFound = L.icon({
    iconUrl: '{% static "images/small-green-cutout.png" %}',
    iconSize: [31, 43],
    iconAnchor: [15, 30],
    popupAnchor: [0, -30]
  });

  function adicionarMarcadores() {
    document.querySelectorAll('.pet-item').forEach(item => {
      const lat = parseFloat(item.dataset.lat?.replace(',', '.') || '');
      const lng = parseFloat(item.dataset.lng?.replace(',', '.') || '');
      if (!isNaN(lat) && !isNaN(lng)) {
        const status = item.dataset.status.toLowerCase();
        const nome = item.querySelector('.card-title')?.innerText || 'Pet';
        const imagem = item.querySelector('img')?.src || '';
        const id = item.dataset.id;
        const markerIcon = (status === 'found' || status === 'encontrado') ? iconFound : iconLost;
        const content = `
          <div style="width: 220px">
            ${imagem ? `<img src="${imagem}" alt="${nome}" style="width:100%; height:120px; object-fit: cover; border-radius: 5px;" />` : ''}
            <h5 class="mt-2">${nome}</h5>
            <a href="/pet/${id}/" class="btn btn-outline-primary btn-sm">Ver detalhes</a>
          </div>
        `;
        L.marker([lat, lng], { icon: markerIcon }).addTo(map).bindPopup(content);
      }
    });
  }

  function centralizarMapa() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          map.setView([pos.coords.latitude, pos.coords.longitude], 13);
          adicionarMarcadores();
        },
        () => {
          fetch('https://ipinfo.io/json?token=91e3040b4f78f5')
            .then(res => res.json())
            .then(data => {
              const [lat, lng] = data.loc.split(',');
              map.setView([parseFloat(lat), parseFloat(lng)], 13);
              adicionarMarcadores();
            });
        }
      );
    }
  }

  centralizarMapa();
});
</script>

<!-- Script do Autocomplete de Raças -->
<script>
const breedsCats = [...]; // mantenha sua lista
const breedsDogs = [...]; // mantenha sua lista
const speciesSelect = document.getElementById('species');
const breedSelect = document.getElementById('breed');
const currentSelected = "{{ breed }}";

function updateBreedOptions() {
  const species = speciesSelect.value;
  const breeds = species === "gato" ? breedsCats : species === "dog" ? breedsDogs : [];

  breedSelect.innerHTML = breeds.length
    ? '<option value="">Todas</option>'
    : '<option value="">Selecione uma espécie primeiro</option>';

  breeds.forEach(breed => {
    const opt = document.createElement('option');
    opt.value = breed;
    opt.text = breed;
    if (breed === currentSelected) opt.selected = true;
    breedSelect.appendChild(opt);
  });
}

updateBreedOptions();
speciesSelect.addEventListener('change', updateBreedOptions);
</script>
{% endblock %}
